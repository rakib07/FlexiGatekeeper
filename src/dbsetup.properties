# To change this license header, choose License Headers in Project Properties.
# To change this template file, choose Tools | Templates
# and open the template in the editor.
#select db
db.create=CREATE DATABASE IF NOT EXISTS {0}
db.use = use {0}

#create tables
db.table.services = CREATE TABLE IF NOT EXISTS `services` (`id` int(11) unsigned NOT NULL AUTO_INCREMENT,`title` varchar(200) NOT NULL,PRIMARY KEY (`id`)) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;   
db.table.users = CREATE TABLE IF NOT EXISTS `users` (`user_id` varchar(200) NOT NULL, `reference_username` varchar(200) NOT NULL,`reference_password` varchar(80) NOT NULL,`created_on` int(11) unsigned NOT NULL,`modified_on` int(11) unsigned NOT NULL,PRIMARY KEY (`user_id`)) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;
db.table.subscribers = CREATE TABLE IF NOT EXISTS `subscribers` (`user_id` varchar(200) NOT NULL, `registration_date` int(11) unsigned NOT NULL,`expired_date` int(11) unsigned NOT NULL,`max_members` int(11) unsigned NOT NULL,`ip_address` varchar(200) NOT NULL,PRIMARY KEY (`user_id`),KEY `fk_subscribers1_idx` (`user_id`)) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;
db.table.subscribers_members = CREATE TABLE IF NOT EXISTS `subscribers_members` (`subscriber_user_id` varchar(200) NOT NULL, `member_user_id` varchar(200) NOT NULL, UNIQUE KEY `uk_subscribers_members` (`subscriber_user_id`,`member_user_id`),KEY `fk_subscribers_members1_idx` (`subscriber_user_id`),KEY `fk_subscribers_members2_idx` (`member_user_id`)) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;
db.table.subscribers_services = CREATE TABLE IF NOT EXISTS `subscribers_services` (`subscriber_user_id` varchar(200) NOT NULL, `service_id` int(11) unsigned NOT NULL,`api_key` varchar(200) NOT NULL,`registration_date` int(11) unsigned NOT NULL,`expired_date` int(11) unsigned NOT NULL,UNIQUE KEY `uk_subscribers_services` (`subscriber_user_id`,`service_id`),KEY `fk_subscribers_services1_idx` (`subscriber_user_id`),KEY `fk_subscribers_services2_idx` (`service_id`)) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;
db.table.transaction_statuses = CREATE TABLE IF NOT EXISTS `transaction_statuses` (`id` int(11) unsigned NOT NULL AUTO_INCREMENT, `title` varchar(200) NOT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1; 
db.table.callback_functions =  CREATE TABLE IF NOT EXISTS `callback_functions` (`api_key` varchar(200) NOT NULL, `callback_function` varchar(1000) NOT NULL, PRIMARY KEY (`api_key`), KEY `fk_callback_functions1_idx` (`api_key`)) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;
db.table.transaction_types = CREATE TABLE IF NOT EXISTS `transaction_types` (`id` int(11) unsigned NOT NULL AUTO_INCREMENT, `title` varchar(200) NOT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1; 
db.table.transactions =  CREATE TABLE IF NOT EXISTS `transactions` (`transaction_id` varchar(200) NOT NULL, `api_key` varchar(200) NOT NULL,  `balance_in` double DEFAULT 0, `balance_out` double DEFAULT 0, `status_id` int(11) unsigned NOT NULL, `type_id` int(11) unsigned NOT NULL, `created_on` int(11) unsigned NOT NULL, `modified_on` int(11) unsigned NOT NULL, PRIMARY KEY (`transaction_id`), KEY `fk_transactions1_idx` (`status_id`), KEY `fk_transactions2_idx` (`type_id`)) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;

#create relations
db.rel.subscribers = ALTER TABLE `subscribers` ADD CONSTRAINT `fk_subscribers1` FOREIGN KEY (`user_id`) REFERENCES `users` (`user_id`) ON DELETE CASCADE ON UPDATE CASCADE;
db.rel.subscribers_members = ALTER TABLE `subscribers_members` ADD CONSTRAINT `fk_subscribers_members1` FOREIGN KEY (`subscriber_user_id`) REFERENCES `users` (`user_id`) ON DELETE CASCADE ON UPDATE CASCADE, ADD CONSTRAINT `fk_subscribers_members2` FOREIGN KEY (`member_user_id`) REFERENCES `users` (`user_id`) ON DELETE CASCADE ON UPDATE CASCADE;
db.rel.subscribers_services = ALTER TABLE `subscribers_services` ADD CONSTRAINT `fk_subscribers_services1` FOREIGN KEY (`subscriber_user_id`) REFERENCES `users` (`user_id`) ON DELETE CASCADE ON UPDATE CASCADE, ADD CONSTRAINT `fk_subscribers_services2` FOREIGN KEY (`service_id`) REFERENCES `services` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;
db.rel.transactions = ALTER TABLE `transactions` ADD CONSTRAINT `fk_transactions1` FOREIGN KEY (`status_id`) REFERENCES `transaction_statuses` (`id`) ON DELETE CASCADE ON UPDATE CASCADE, ADD CONSTRAINT `fk_transactions2` FOREIGN KEY (`type_id`) REFERENCES `transaction_types` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

#insert default data
db.defaultData.services = INSERT INTO `services` (`id`, `title`) VALUES (1, 'BKash Send Money'), (2, 'Topup Service');
db.defaultData.users = INSERT INTO `users` (`user_id`, `reference_username`, `reference_password`, `created_on`, `modified_on`) VALUES ('1', 'ru1', 'rp1', 1392232479, 1392232479), ('2', 'ru2', 'rp2', 1392232479, 1392232479);
db.defaultData.subscribers = INSERT INTO `subscribers` (`user_id`, `registration_date`, `expired_date`, `max_members`, `ip_address`) VALUES ('1', 1392232479, 1392232479, 10, '192.168.1.1');
db.defaultData.subscribers_members = INSERT INTO `subscribers_members` (`subscriber_user_id`, `member_user_id`) VALUES ('1', '1'), ('1', '2');
db.defaultData.subscribers_services = INSERT INTO `subscribers_services` (`subscriber_user_id`, `service_id`, `api_key`, `registration_date`, `expired_date`) VALUES ('1', 1, 'key1', 1392232479, 1392232479), ('1', 2, 'key2', 1392232479, 1392232479);
db.defaultData.callback_functions = INSERT INTO `callback_functions` (`api_key`, `callback_function`) VALUES ('key1', 'callback1');
db.defaultData.transaction_statuses = INSERT INTO `transaction_statuses` (`id`, `title`) VALUES (1, 'Pending'), (2, 'Success'), (3, 'Failed'), (4, 'Cancelled');
db.defaultData.transaction_types = INSERT INTO `transaction_types` (`id`, `title`) VALUES (1, 'Raise Balance'), (2, 'Use Service');
db.defaultData.transactions = INSERT INTO `transactions` (`transaction_id`, `api_key`, `balance_in`, `balance_out`, `status_id`, `type_id`, `created_on`, `modified_on`) VALUES ('t1', 'key1', 100000, 0, 2, 1, 1392232479, 1392232479), ('t2', 'key1', 0, 5000, 1, 2, 1392232479, 1392232479);